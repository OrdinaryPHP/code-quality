name: "Build, test, and deploy"
on:
  push:
    branches:
      - dev
    tags:
      - '**'
permissions:
  contents: read
jobs:
  build:
    strategy:
      matrix:
        php-version: ["8.1", "8.2"]

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@main

      - name: Create version tag
        run: |
          echo "VERSION_TAG=${{ github.ref_name }}-php${{ matrix.php-version }}" >> $GITHUB_ENV
          echo "Tag: $VERSION_TAG"

      - name: Create image tags
        run: |
          echo "GHCR_TAG=ghcr.io/ordinaryphp/code-quality:$VERSION_TAG" >> $GITHUB_ENV
          echo "DOCKER_TAG=tricyn/code-quality:$VERSION_TAG" >> $GITHUB_ENV
          echo "GHCR Tag: $GHCR_TAG"
          echo "Docker Tag: $DOCKER_TAG"

      - name: Build Container
        run: docker build --build-arg INPUT_PHP_VERSION=${{ matrix.php-version }} -t $DOCKER_TAG -t $GHCR_TAG .

      - name: Lint
        run: docker run --rm -v $GITHUB_WORKSPACE:/opt/project -w /opt/project $GHCR_TAG /code-quality/vendor/bin/phplint

      - name: Static Analysis
        run: docker run --rm -v $GITHUB_WORKSPACE:/opt/project -w /opt/project $GHCR_TAG /code-quality/vendor/bin/psalm

      - name: Code Style
        run: docker run --rm -v $GITHUB_WORKSPACE:/opt/project -w /opt/project $GHCR_TAG /code-quality/vendor/bin/phpcs
